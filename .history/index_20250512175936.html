<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高性能在线图片工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="./favicon.svg" type="image/svg+xml">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .upload-area {
            border: 2px dashed #9ca3af; /* Gray border */
            transition: border-color 0.3s, background-color 0.3s;
        }
        .upload-area.dragover {
            border-color: #3b82f6; /* Blue border on dragover */
            background-color: #eff6ff; /* Light blue background on dragover */
        }
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb; /* Gray background for progress bar */
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 0.75rem; /* 12px */
            background-color: #3b82f6; /* Blue progress */
            transition: width 0.3s ease-in-out;
            border-radius: 0.375rem;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 160px;
            background-color: #374151; /* Dark gray tooltip */
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -80px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .settings-panel {
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
            transform: translateY(10px);
        }
        .settings-panel.panel-active {
            opacity: 1;
            transform: translateY(0);
        }
        /* Custom scrollbar for file list */
        .file-list-container::-webkit-scrollbar {
            width: 8px;
        }
        .file-list-container::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        .file-list-container::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        .file-list-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Ensure buttons are accessible and look good */
        .btn {
            padding: 0.625rem 1.25rem; /* 10px 20px */
            border-radius: 0.375rem; /* 6px */
            font-weight: 500;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background-color: #3b82f6; /* Blue */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker blue */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-secondary {
            background-color: #6b7280; /* Gray */
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Darker gray */
        }
        .btn-danger {
            background-color: #ef4444; /* Red */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* Darker red */
        }
        .btn-outline {
            background-color: transparent;
            color: #3b82f6; /* Blue */
            border: 1px solid #3b82f6;
        }
        .btn-outline:hover {
            background-color: #eff6ff; /* Light blue */
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #d1d5db; /* Gray track */
            border-radius: 5px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6; /* Blue thumb */
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6; /* Blue thumb */
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            border-radius: 0.375rem 0.375rem 0 0;
            font-weight: 500;
            cursor: pointer;
            background-color: #e5e7eb; /* Light gray inactive tab */
            color: #4b5563; /* Dark gray text */
            border: 1px solid #d1d5db;
            border-bottom: none;
        }
        .tab-button.active {
            background-color: #fff; /* White active tab */
            color: #3b82f6; /* Blue text */
            border-color: #d1d5db;
            border-bottom: 1px solid #fff; /* Hide bottom border part covered by content */
            position: relative;
            top: 1px; /* Align with content border */
        }
        .tab-content {
            border: 1px solid #d1d5db;
            border-top: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 md:p-8">

    <div class="bg-white shadow-xl rounded-lg w-full max-w-4xl p-6 md:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">高性能在线图片工具</h1>
            <p class="text-gray-600 mt-2">在浏览器中安全快速地压缩和转换您的图片。</p>
        </header>

        <section id="uploadSection" class="mb-8">
            <div id="uploadArea" class="upload-area p-8 md:p-12 text-center rounded-lg cursor-pointer hover:bg-gray-50">
                <input type="file" id="fileInput" multiple accept="image/jpeg, image/png, image/gif, image/bmp, image/webp" class="hidden">
                <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                <p class="text-lg font-medium text-gray-700">将图片拖拽至此，或 <span class="text-blue-600 hover:text-blue-800">点击选择文件</span></p>
                <p class="text-sm text-gray-500 mt-1">支持 JPG, PNG, GIF, BMP, WebP 格式</p>
                <p class="text-xs text-gray-500 mt-1">提示：动画GIF将仅处理第一帧进行压缩/转换。</p>
            </div>
        </section>

        <section id="settingsSection" class="mb-8 hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">压缩模式</h3>
                    <div class="space-y-2">
                        <div>
                            <input type="radio" id="modeCustom" name="compressionMode" value="custom" class="mr-2" checked>
                            <label for="modeCustom" class="text-gray-700">自定义压缩</label>
                        </div>
                        <div>
                            <input type="radio" id="modeShrink" name="compressionMode" value="shrink" class="mr-2">
                            <label for="modeShrink" class="text-gray-700">缩小优先</label>
                        </div>
                        <div>
                            <input type="radio" id="modeNormal" name="compressionMode" value="normal" class="mr-2">
                            <label for="modeNormal" class="text-gray-700">普通压缩</label>
                        </div>
                        <div>
                            <input type="radio" id="modeClear" name="compressionMode" value="clear" class="mr-2">
                            <label for="modeClear" class="text-gray-700">清晰优先</label>
                        </div>
                    </div>
                </div>

                <div id="customSettingsPanel" class="settings-panel md:col-span-2 bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">自定义设置</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="qualitySlider" class="block text-sm font-medium text-gray-700">图片质量: <span id="qualityValue">0.8</span></label>
                            <input type="range" id="qualitySlider" min="0.1" max="1" step="0.05" value="0.8" class="w-full mt-1">
                            <p class="text-xs text-gray-500 mt-1">适用于 JPG 和 WebP 格式。值越小，压缩率越高，文件越小。</p>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label for="maxWidthInput" class="block text-sm font-medium text-gray-700">最大宽度 (px)</label>
                                <input type="number" id="maxWidthInput" placeholder="例如: 1920" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="maxHeightInput" class="block text-sm font-medium text-gray-700">最大高度 (px)</label>
                                <input type="number" id="maxHeightInput" placeholder="例如: 1080" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                        </div>
                         <p class="text-xs text-gray-500">如果同时设置宽度和高度，图片将按比例缩放以适应两者。</p>
                        <div>
                            <label for="outputFormatSelect" class="block text-sm font-medium text-gray-700">输出格式</label>
                            <select id="outputFormatSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                <option value="image/jpeg">JPG</option>
                                <option value="image/png">PNG</option>
                                <option value="image/webp">WebP</option>
                                <option value="original">保持原始格式 (若支持)</option>
                            </select>
                             <p class="text-xs text-gray-500 mt-1">BMP将转换为所选格式。GIF将转换为静态图片。</p>
                        </div>
                    </div>
                </div>
                
                <!-- 缩小优先设置面板 -->
                <div id="shrinkSettingsPanel" class="settings-panel md:col-span-2 bg-gray-50 p-4 rounded-lg hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">缩小优先模式</h3>
                    <div class="space-y-4">
                        <p class="text-gray-700">此模式将优先减小图片尺寸，适合需要快速加载的网页图片。</p>
                        <div class="bg-blue-50 p-3 rounded-md">
                            <h4 class="font-medium text-blue-700">预设参数:</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 mt-2 space-y-1">
                                <li>图片质量: 0.6 (中等压缩)</li>
                                <li>最大尺寸: 1280×720 像素</li>
                                <li>输出格式: JPG</li>
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600">此模式可以显著减小文件大小，但可能会降低图片质量。</p>
                    </div>
                </div>
                
                <!-- 普通压缩设置面板 -->
                <div id="normalSettingsPanel" class="settings-panel md:col-span-2 bg-gray-50 p-4 rounded-lg hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">普通压缩模式</h3>
                    <div class="space-y-4">
                        <p class="text-gray-700">此模式提供平衡的压缩效果，适合大多数使用场景。</p>
                        <div class="bg-blue-50 p-3 rounded-md">
                            <h4 class="font-medium text-blue-700">预设参数:</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 mt-2 space-y-1">
                                <li>图片质量: 0.75 (良好质量)</li>
                                <li>最大尺寸: 1920×1080 像素</li>
                                <li>输出格式: JPG</li>
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600">此模式在文件大小和图片质量之间取得良好平衡。</p>
                    </div>
                </div>
                
                <!-- 清晰优先设置面板 -->
                <div id="clearSettingsPanel" class="settings-panel md:col-span-2 bg-gray-50 p-4 rounded-lg hidden">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">清晰优先模式</h3>
                    <div class="space-y-4">
                        <p class="text-gray-700">此模式优先保证图片清晰度，适合需要高质量展示的图片。</p>
                        <div class="bg-blue-50 p-3 rounded-md">
                            <h4 class="font-medium text-blue-700">预设参数:</h4>
                            <ul class="list-disc list-inside text-sm text-gray-700 mt-2 space-y-1">
                                <li>图片质量: 0.9 (高质量)</li>
                                <li>保持原始尺寸</li>
                                <li>输出格式: WebP (更好的压缩效果)</li>
                            </ul>
                        </div>
                        <p class="text-sm text-gray-600">此模式会保持较高的图片质量，压缩率相对较低。</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="processingSection" class="mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">待处理文件</h2>
                <button id="startProcessingBtn" class="btn btn-primary">开始处理</button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 p-4 rounded-lg max-h-96 overflow-y-auto file-list-container">
                    <ul id="fileList" class="space-y-3">
                        </ul>
                </div>

                <div id="previewArea" class="bg-gray-50 p-4 rounded-lg hidden">
                     <h3 class="text-lg font-semibold text-gray-700 mb-3">图片预览: <span id="previewFileName" class="text-base font-normal"></span></h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                        <div>
                            <h4 class="text-center text-sm font-medium text-gray-600 mb-2">处理前</h4>
                            <img id="previewOriginal" src="https://placehold.co/400x300/e2e8f0/94a3b8?text=处理前" alt="处理前图片" class="preview-image mx-auto">
                            <p id="previewOriginalSize" class="text-center text-xs text-gray-500 mt-1"></p>
                        </div>
                        <div>
                            <h4 class="text-center text-sm font-medium text-gray-600 mb-2">处理后</h4>
                            <img id="previewProcessed" src="https://placehold.co/400x300/e2e8f0/94a3b8?text=处理后" alt="处理后图片" class="preview-image mx-auto">
                            <p id="previewProcessedSize" class="text-center text-xs text-gray-500 mt-1"></p>
                            <p id="previewSavings" class="text-center text-sm font-semibold text-green-600 mt-1"></p>
                        </div>
                    </div>
                    <div id="previewPlaceholder" class="text-center text-gray-500 py-10">
                        <p>点击文件列表中的“预览”按钮查看对比效果。</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="resultsSection" class="hidden">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">处理结果</h2>
                <div class="space-x-2">
                    <button id="clearResultsBtn" class="btn btn-outline">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        清除结果
                    </button>
                    <button id="batchDownloadBtn" class="btn btn-secondary hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        批量下载 (.zip)
                    </button>
                </div>
            </div>
            <div id="processedFileList" class="space-y-3 max-h-96 overflow-y-auto file-list-container bg-gray-50 p-4 rounded-lg">
            </div>
        </section>

        <div id="messageArea" class="mt-6">
            </div>

        <footer class="mt-12 text-center">
            <p class="text-sm text-gray-500">&copy; <span id="currentYear"></span> 高性能在线图片工具</p>
        </footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.2.1/compressor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pica/9.0.1/pica.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // --- DOM Elements ---
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const settingsSection = document.getElementById('settingsSection');
        const processingSection = document.getElementById('processingSection');
        const resultsSection = document.getElementById('resultsSection');
        const customSettingsPanel = document.getElementById('customSettingsPanel');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const maxWidthInput = document.getElementById('maxWidthInput');
        const maxHeightInput = document.getElementById('maxHeightInput');
        const outputFormatSelect = document.getElementById('outputFormatSelect');
        const fileListUI = document.getElementById('fileList');
        const processedFileListUI = document.getElementById('processedFileList');
        const startProcessingBtn = document.getElementById('startProcessingBtn');
        const batchDownloadBtn = document.getElementById('batchDownloadBtn');
        const clearResultsBtn = document.getElementById('clearResultsBtn');
        const previewArea = document.getElementById('previewArea');
        const previewOriginalImg = document.getElementById('previewOriginal');
        const previewProcessedImg = document.getElementById('previewProcessed');
        const previewOriginalSize = document.getElementById('previewOriginalSize');
        const previewProcessedSize = document.getElementById('previewProcessedSize');
        const previewSavings = document.getElementById('previewSavings');
        const previewFileName = document.getElementById('previewFileName');
        const previewPlaceholder = document.getElementById('previewPlaceholder');
        const messageArea = document.getElementById('messageArea');
        const compressionModeRadios = document.querySelectorAll('input[name="compressionMode"]');

        // --- Global State ---
        let uploadedFiles = []; // Array of {id: string, file: File, originalURL: string, processedBlob?: Blob, processedURL?: string, originalSize: number, processedSize?: number, status: string, error?: string, progress: number }
        let selectedPreviewId = null;
        const picaInstance = pica();

        // --- Utility Functions ---
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function showMessage(type, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `p-3 rounded-md text-sm mb-2 ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}`;
            messageDiv.textContent = text;
            messageArea.appendChild(messageDiv);
            setTimeout(() => messageDiv.remove(), 5000);
        }

        // --- File Handling ---
        // 事件监听器现在通过initializeUploadArea函数添加

        function handleFiles(files) {
            if (files.length === 0) return;
            settingsSection.classList.remove('hidden');
            processingSection.classList.remove('hidden');
            resultsSection.classList.remove('hidden'); // Show results section container
            
            const newFiles = Array.from(files).map(file => ({
                id: generateId(),
                file: file,
                originalURL: URL.createObjectURL(file),
                originalSize: file.size,
                status: 'pending', // pending, processing, done, error
                progress: 0
            }));
            uploadedFiles = uploadedFiles.concat(newFiles);
            renderFileList();
            if (uploadedFiles.length > 0 && !selectedPreviewId) {
                 // Auto-select first file for preview if nothing is selected
                // selectForPreview(uploadedFiles[0].id);
            }
        }

        function renderFileList() {
            fileListUI.innerHTML = ''; // Clear existing list
            uploadedFiles.forEach(f => {
                if (f.status === 'done' || f.status === 'error') return; // Don't show processed files here

                const li = document.createElement('li');
                li.className = 'p-3 bg-white rounded-md shadow flex flex-col sm:flex-row items-start sm:items-center justify-between';
                li.dataset.id = f.id;

                let progressHtml = '';
                if (f.status === 'processing') {
                    progressHtml = `
                        <div class="w-full sm:w-1/3 mt-2 sm:mt-0 sm:ml-4 progress-bar-container">
                            <div class="progress-bar" style="width: ${f.progress}%"></div>
                        </div>
                    `;
                } else {
                     progressHtml = `<div class="w-full sm:w-1/3 mt-2 sm:mt-0 sm:ml-4 text-xs text-gray-500">状态: ${f.status === 'pending' ? '待处理' : f.status}</div>`;
                }


                li.innerHTML = `
                    <div class="flex-grow overflow-hidden mb-2 sm:mb-0">
                        <p class="text-sm font-medium text-gray-800 truncate" title="${f.file.name}">${f.file.name}</p>
                        <p class="text-xs text-gray-500">${formatBytes(f.originalSize)}</p>
                    </div>
                    ${progressHtml}
                    <div class="ml-0 sm:ml-4 flex-shrink-0 mt-2 sm:mt-0 space-x-2">
                        <button class="btn-preview btn btn-outline btn-sm py-1 px-2 text-xs">预览</button>
                        <button class="btn-remove btn btn-danger btn-sm py-1 px-2 text-xs">移除</button>
                    </div>
                `;
                fileListUI.appendChild(li);
            });

            // Add event listeners for new buttons
            document.querySelectorAll('.btn-preview').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('li').dataset.id;
                    selectForPreview(id);
                });
            });
            document.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.closest('li').dataset.id;
                    removeFile(id);
                });
            });
            
            if (uploadedFiles.filter(f => f.status === 'pending' || f.status === 'processing').length === 0) {
                 if(uploadedFiles.length > 0) { // only hide if all files are processed or removed, but there were files
                    // processingSection.classList.add('hidden'); // Or show a message "All files processed"
                 } else { // No files at all
                    settingsSection.classList.add('hidden');
                    processingSection.classList.add('hidden');
                    resultsSection.classList.add('hidden');
                    previewArea.classList.add('hidden');
                 }
            }
        }
        
        function removeFile(id) {
            uploadedFiles = uploadedFiles.filter(f => f.id !== id);
            if (selectedPreviewId === id) {
                clearPreview();
                selectedPreviewId = null;
            }
            renderFileList();
            renderProcessedFileList(); // Also update processed list if item was there
            if (uploadedFiles.length === 0) {
                settingsSection.classList.add('hidden');
                processingSection.classList.add('hidden');
                resultsSection.classList.add('hidden');
                batchDownloadBtn.classList.add('hidden');
            }
        }

        function selectForPreview(id) {
            selectedPreviewId = id;
            const fileData = uploadedFiles.find(f => f.id === id);
            if (fileData) {
                previewArea.classList.remove('hidden');
                previewPlaceholder.classList.add('hidden');
                previewFileName.textContent = fileData.file.name;
                previewOriginalImg.src = fileData.originalURL;
                previewOriginalSize.textContent = `原始大小: ${formatBytes(fileData.originalSize)}`;

                if (fileData.processedURL && fileData.processedSize) {
                    previewProcessedImg.src = fileData.processedURL;
                    previewProcessedImg.onerror = () => { previewProcessedImg.src = "https://placehold.co/400x300/e2e8f0/94a3b8?text=预览加载失败"; };
                    previewProcessedSize.textContent = `处理后: ${formatBytes(fileData.processedSize)}`;
                    const savings = ((fileData.originalSize - fileData.processedSize) / fileData.originalSize) * 100;
                    previewSavings.textContent = savings > 0 ? `节省: ${savings.toFixed(1)}%` : (savings < 0 ? `增大: ${Math.abs(savings).toFixed(1)}%` : '大小不变');
                    previewSavings.className = `text-center text-sm font-semibold mt-1 ${savings > 0 ? 'text-green-600' : (savings < 0 ? 'text-red-600' : 'text-gray-600')}`;

                } else {
                    previewProcessedImg.src = "https://placehold.co/400x300/e2e8f0/94a3b8?text=待处理";
                    previewProcessedSize.textContent = '处理后: -';
                    previewSavings.textContent = '';
                }
            }
        }
        
        // 清除结果按钮事件
        clearResultsBtn.addEventListener('click', () => {
            // 清空处理结果列表
            uploadedFiles = uploadedFiles.filter(file => file.status !== 'done');
            processedFileListUI.innerHTML = '';
            
            // 隐藏结果区域和批量下载按钮
            resultsSection.classList.add('hidden');
            batchDownloadBtn.classList.add('hidden');
            clearResultsBtn.classList.add('hidden');
            
            // 如果预览区域显示的是已处理文件，也隐藏预览
            if (document.getElementById('previewArea')) {
                document.getElementById('previewArea').classList.add('hidden');
            }
            
            showMessage('info', '已清除所有处理结果');
            
            // 如果还有待处理文件，显示处理区域
            if (uploadedFiles.length > 0) {
                processingSection.classList.remove('hidden');
                renderFileList();
            } else {
                // 如果没有任何文件，显示上传区域并确保其可用
                uploadArea.classList.remove('hidden');
                settingsSection.classList.remove('hidden');
                processingSection.classList.add('hidden');
                
                // 重新初始化上传区域的事件监听器
                initializeUploadArea();
            }
        });

        function clearPreview() {
            previewArea.classList.add('hidden');
            previewPlaceholder.classList.remove('hidden');
            previewFileName.textContent = '';
            previewOriginalImg.src = "https://placehold.co/400x300/e2e8f0/94a3b8?text=处理前";
            previewProcessedImg.src = "https://placehold.co/400x300/e2e8f0/94a3b8?text=处理后";
            previewOriginalSize.textContent = '';
            previewProcessedSize.textContent = '';
            previewSavings.textContent = '';
            selectedPreviewId = null;
        }

        // --- Compression Logic ---
        qualitySlider.addEventListener('input', (e) => {
            qualityValue.textContent = e.target.value;
        });

        compressionModeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                customSettingsPanel.style.display = e.target.value === 'custom' ? 'block' : 'none';
            });
        });
        
        startProcessingBtn.addEventListener('click', async () => {
            const filesToProcess = uploadedFiles.filter(f => f.status === 'pending');
            if (filesToProcess.length === 0) {
                showMessage('error', '没有待处理的文件');
                return;
            }
            
            // 禁用开始处理按钮
            startProcessingBtn.disabled = true;
            startProcessingBtn.textContent = '处理中...';
            startProcessingBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // 处理所有文件
            for (const fileObj of filesToProcess) {
                await processImage(fileObj);
            }
            
            // 恢复按钮状态
            startProcessingBtn.disabled = false;
            startProcessingBtn.textContent = '开始处理';
            startProcessingBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            
            const processedCount = uploadedFiles.filter(f => f.status === 'done').length;
            if (processedCount > 0) {
                batchDownloadBtn.classList.remove('hidden');
            }
            
            showMessage('info', '所有文件处理完成');
        });

        function getCompressorOptions(mode, originalMimeType) {
            let quality = parseFloat(qualitySlider.value);
            let maxWidth = parseInt(maxWidthInput.value) || undefined;
            let maxHeight = parseInt(maxHeightInput.value) || undefined;
            let mimeType = outputFormatSelect.value;

            if (mimeType === 'original') {
                // Allow common types, default to jpeg if unknown or problematic (like BMP)
                const allowedOriginals = ['image/jpeg', 'image/png', 'image/webp'];
                if (allowedOriginals.includes(originalMimeType)) {
                    mimeType = originalMimeType;
                } else if (originalMimeType === 'image/gif') {
                     mimeType = 'image/gif'; // Compressor.js handles GIF first frame
                }
                 else {
                    mimeType = 'image/jpeg'; // Fallback for BMP or other types
                }
            }
            
            // For PNG output, quality is often ignored or handled differently (lossless)
            // Compressor.js documentation: "The compression quality for JPEG or WebP images."
            // So, for PNG, we might not need to pass quality, or it won't have an effect.

            const baseOptions = {
                strict: true, // Use original image if compressed one is larger (with exceptions)
                checkOrientation: true, // Read EXIF Orientation
                // convertSize: 5000000, // 5MB, convert to JPEG if PNG is too large (optional)
            };

            switch (mode) {
                case 'custom':
                    return { ...baseOptions, quality, maxWidth, maxHeight, mimeType };
                case 'shrink':
                    // Pica handles initial resize. Compressor.js does further compression.
                    return { ...baseOptions, quality: 0.7, maxWidth: maxWidth || 800, maxHeight: maxHeight || 800, mimeType: mimeType === 'original' ? 'image/jpeg' : mimeType };
                case 'normal':
                    return { ...baseOptions, quality: 0.8, maxWidth: maxWidth || 1920, maxHeight: maxHeight || 1920, mimeType: mimeType === 'original' ? 'image/jpeg' : mimeType };
                case 'clear':
                    return { ...baseOptions, quality: 0.95, maxWidth, maxHeight, mimeType: mimeType === 'original' ? (originalMimeType === 'image/png' ? 'image/png' : 'image/jpeg') : mimeType };
                default:
                    return { ...baseOptions, quality: 0.8, mimeType: 'image/jpeg' };
            }
        }

        async function resizeWithPica(file, options) {
            // options: { maxWidth, maxHeight }
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    let targetWidth = img.width;
                    let targetHeight = img.height;
                    const aspectRatio = img.width / img.height;

                    if (options.maxWidth && options.maxHeight) {
                        if (img.width / options.maxWidth > img.height / options.maxHeight) {
                            targetWidth = options.maxWidth;
                            targetHeight = targetWidth / aspectRatio;
                        } else {
                            targetHeight = options.maxHeight;
                            targetWidth = targetHeight * aspectRatio;
                        }
                    } else if (options.maxWidth) {
                        targetWidth = options.maxWidth;
                        targetHeight = targetWidth / aspectRatio;
                    } else if (options.maxHeight) {
                        targetHeight = options.maxHeight;
                        targetWidth = targetHeight * aspectRatio;
                    }
                    
                    // Ensure dimensions are integers
                    targetWidth = Math.round(targetWidth);
                    targetHeight = Math.round(targetHeight);

                    if (targetWidth <= 0 || targetHeight <=0) { // Avoid invalid canvas size
                        console.warn("Pica resize resulted in zero or negative dimension, using original image.");
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        resolve(canvas);
                        return;
                    }

                    const offScreenCanvas = document.createElement('canvas');
                    offScreenCanvas.width = targetWidth;
                    offScreenCanvas.height = targetHeight;

                    picaInstance.resize(img, offScreenCanvas, {
                        // Pica options: alpha (for transparency), unsharpAmount, unsharpRadius, unsharpThreshold
                        alpha: true 
                    })
                    .then(result => resolve(result))
                    .catch(err => reject(err));
                };
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }
        
        // --- Results and Download ---
        function renderProcessedFileList() {
            processedFileListUI.innerHTML = '';
            const doneFiles = uploadedFiles.filter(f => f.status === 'done' || f.status === 'error');

            if (doneFiles.length === 0 && uploadedFiles.filter(f => f.status !== 'pending' && f.status !== 'processing').length === 0) {
                 // resultsSection.classList.add('hidden'); // Keep results section visible if files were uploaded
                 processedFileListUI.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">还没有处理完成的文件。</p>';
                 batchDownloadBtn.classList.add('hidden');
                 clearResultsBtn.classList.add('hidden'); // 隐藏清除结果按钮
                 return;
            }
             if (doneFiles.length === 0 && uploadedFiles.length > 0) {
                 processedFileListUI.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">所有文件正在等待处理或处理中。</p>';
                 batchDownloadBtn.classList.add('hidden');
                 clearResultsBtn.classList.add('hidden'); // 隐藏清除结果按钮
                 return;
             }


            doneFiles.forEach(f => {
                const li = document.createElement('li');
                li.className = 'p-3 bg-white rounded-md shadow flex flex-col sm:flex-row items-start sm:items-center justify-between';
                
                let resultInfoHtml = '';
                if (f.status === 'done') {
                    const savings = ((f.originalSize - f.processedSize) / f.originalSize) * 100;
                    const savingsText = savings > 0 ? `节省 ${savings.toFixed(1)}%` : (savings < 0 ? `增大 ${Math.abs(savings).toFixed(1)}%` : '大小不变');
                    const savingsColor = savings > 0 ? 'text-green-600' : (savings < 0 ? 'text-red-600' : 'text-gray-600');
                    resultInfoHtml = `
                        <p class="text-xs text-gray-500">原: ${formatBytes(f.originalSize)} → 新: ${formatBytes(f.processedSize)}</p>
                        <p class="text-xs font-semibold ${savingsColor}">${savingsText}</p>
                    `;
                } else { // Error
                     resultInfoHtml = `<p class="text-xs text-red-500">错误: ${f.error || '未知错误'}</p>`;
                }

                li.innerHTML = `
                    <div class="flex-grow overflow-hidden mb-2 sm:mb-0">
                        <p class="text-sm font-medium text-gray-800 truncate" title="${f.file.name}">${f.file.name}</p>
                        ${resultInfoHtml}
                    </div>
                    <div class="ml-0 sm:ml-4 flex-shrink-0 mt-2 sm:mt-0 space-x-2">
                        ${f.status === 'done' ? `<button data-id="${f.id}" class="btn-download btn btn-primary btn-sm py-1 px-2 text-xs">下载</button>` : ''}
                        <button data-id="${f.id}" class="btn-preview-processed btn btn-outline btn-sm py-1 px-2 text-xs">预览</button>
                        <button data-id="${f.id}" class="btn-remove-processed btn btn-danger btn-sm py-1 px-2 text-xs">移除</button>
                    </div>
                `;
                processedFileListUI.appendChild(li);
            });
            
            document.querySelectorAll('.btn-download').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    const fileData = uploadedFiles.find(f => f.id === id);
                    if (fileData && fileData.processedBlob) {
                        downloadBlob(fileData.processedBlob, fileData.file.name);
                    }
                });
            });
             document.querySelectorAll('.btn-preview-processed').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    selectForPreview(id); // This will show original and processed
                });
            });
            document.querySelectorAll('.btn-remove-processed').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    removeFile(id); // Universal remove function
                });
            });

            if (uploadedFiles.filter(f => f.status === 'done').length > 0) {
                batchDownloadBtn.classList.remove('hidden');
                clearResultsBtn.classList.remove('hidden'); // 显示清除结果按钮
            } else {
                batchDownloadBtn.classList.add('hidden');
                clearResultsBtn.classList.add('hidden'); // 隐藏清除结果按钮
            }
             if (doneFiles.length === 0 && uploadedFiles.length === 0) { // No files at all
                resultsSection.classList.add('hidden');
             } else {
                resultsSection.classList.remove('hidden');
             }
        }

        // --- Compression Mode Handling ---
        compressionModeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // 隐藏所有设置面板
                document.querySelectorAll('.settings-panel').forEach(panel => {
                    panel.classList.add('hidden');
                    panel.classList.remove('panel-active');
                });
                
                // 显示对应的设置面板
                const selectedMode = this.value;
                const targetPanel = document.getElementById(`${selectedMode}SettingsPanel`);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                    // 添加动画效果
                    setTimeout(() => {
                        targetPanel.classList.add('panel-active');
                    }, 10);
                }
                
                // 更新压缩设置
                updateCompressionSettings();
            });
        });

        function updateCompressionSettings() {
            const selectedMode = document.querySelector('input[name="compressionMode"]:checked').value;
            
            // 根据不同模式设置默认参数
            switch (selectedMode) {
                case 'shrink':
                    qualitySlider.value = 0.6;
                    qualityValue.textContent = '0.6';
                    maxWidthInput.value = '1280';
                    maxHeightInput.value = '720';
                    outputFormatSelect.value = 'image/jpeg';
                    break;
                case 'normal':
                    qualitySlider.value = 0.75;
                    qualityValue.textContent = '0.75';
                    maxWidthInput.value = '1920';
                    maxHeightInput.value = '1080';
                    outputFormatSelect.value = 'image/jpeg';
                    break;
                case 'clear':
                    qualitySlider.value = 0.9;
                    qualityValue.textContent = '0.9';
                    maxWidthInput.value = '';
                    maxHeightInput.value = '';
                    outputFormatSelect.value = 'image/webp';
                    break;
                case 'custom':
                    // 保持用户自定义设置
                    break;
            }
        }

        function downloadBlob(blob, filename) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            // Try to infer extension or add one
            const nameParts = filename.split('.');
            let baseName = filename;
            if (nameParts.length > 1) {
                baseName = nameParts.slice(0, -1).join('.');
            }
            
            let newExtension = 'jpg'; // Default
            if (blob.type === 'image/png') newExtension = 'png';
            else if (blob.type === 'image/webp') newExtension = 'webp';
            else if (blob.type === 'image/gif') newExtension = 'gif';

            link.download = `${baseName}_processed.${newExtension}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        // 获取文件扩展名的辅助函数
        function getFileExtension(filename) {
            return filename.slice((filename.lastIndexOf('.') - 1 >>> 0) + 2).toLowerCase();
        }

        // --- Batch Download ---
        batchDownloadBtn.addEventListener('click', async () => {
            if (uploadedFiles.filter(f => f.status === 'done').length === 0) {
                showMessage('error', '没有可下载的已处理文件');
                return;
            }
            
            try {
                showMessage('info', '正在准备ZIP文件...');
                const zip = new JSZip();
                
                // 添加所有已处理的文件到zip
                uploadedFiles.filter(f => f.status === 'done').forEach(file => {
                    // 获取正确的文件扩展名
                    let extension = getFileExtension(file.file.name);
                    
                    // 如果输出格式不是"original"，则根据输出格式更新扩展名
                    if (file.outputFormat && file.outputFormat !== 'original') {
                        extension = file.outputFormat.split('/')[1];
                        // 特殊处理jpeg格式
                        if (extension === 'jpeg') extension = 'jpg';
                    }
                    
                    // 创建不带扩展名的文件名基础部分
                    const baseFileName = file.file.name.substring(0, file.file.name.lastIndexOf('.'));
                    // 创建新的文件名，添加"_compressed"后缀和正确的扩展名
                    const newFileName = `${baseFileName}_compressed.${extension}`;
                    
                    // 将处理后的文件添加到zip中
                    zip.file(newFileName, file.processedBlob);
                });
                
                // 生成zip文件
                const zipBlob = await zip.generateAsync({type: 'blob'});
                
                // 创建下载链接
                const downloadLink = document.createElement('a');
                downloadLink.href = URL.createObjectURL(zipBlob);
                downloadLink.download = 'compressed_images.zip';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                URL.revokeObjectURL(downloadLink.href);
                
                showMessage('info', 'ZIP文件已准备好，开始下载');
            } catch (error) {
                console.error('批量下载出错:', error);
                showMessage('error', '创建ZIP文件时出错: ' + error.message);
            }
        });

        // 获取当前压缩设置
        function getCurrentSettings() {
            const mode = document.querySelector('input[name="compressionMode"]:checked').value;
            const quality = parseFloat(qualitySlider.value);
            const maxWidth = parseInt(maxWidthInput.value) || undefined;
            const maxHeight = parseInt(maxHeightInput.value) || undefined;
            const outputFormat = outputFormatSelect.value;
            
            return { mode, quality, maxWidth, maxHeight, outputFormat };
        }

        // 在处理图片时保存输出格式信息
        async function processImage(fileObj) {
            try {
                fileObj.status = 'processing';
                fileObj.progress = 0;
                renderFileList();
                
                const mode = document.querySelector('input[name="compressionMode"]:checked').value;
                const options = getCompressorOptions(mode, fileObj.file.type);
                
                // If mode is 'shrink' and it's not a GIF, use Pica first for resizing
                let fileToCompress = fileObj.file;
                if (mode === 'shrink' && fileObj.file.type !== 'image/gif') {
                     if (options.maxWidth || options.maxHeight) {
                        fileObj.progress = 10; renderFileList();
                        const resizedCanvas = await resizeWithPica(fileObj.file, {
                            maxWidth: options.maxWidth || 800, // Default shrink size
                            maxHeight: options.maxHeight || 800
                        });
                        fileToCompress = await new Promise(resolve => resizedCanvas.toBlob(resolve, fileObj.file.type, options.quality || 0.7));
                        fileObj.progress = 40; renderFileList();
                     }
                }
                
                // Compressor.js doesn't have a direct progress callback for the compression itself.
                // We can simulate some progress.
                // If Pica was used, progress is already at 40. Otherwise, start from 10.
                fileObj.progress = fileObj.progress > 0 ? fileObj.progress : 10;
                renderFileList();

                const compressedBlob = await new Promise((resolve, reject) => {
                    new Compressor(fileToCompress, {
                        ...options,
                        success: resolve,
                        error: reject,
                    });
                });
                
                fileObj.progress = 90; renderFileList();

                fileObj.processedBlob = compressedBlob;
                fileObj.processedURL = URL.createObjectURL(compressedBlob);
                fileObj.processedSize = compressedBlob.size;
                fileObj.status = 'done';
                fileObj.progress = 100;
                
                // 保存输出格式信息
                fileObj.outputFormat = options.mimeType || fileObj.file.type;
                
                renderFileList(); // Update status after processing
                renderProcessedFileList(); // Add to processed list
                if (selectedPreviewId === fileObj.id) { // Update preview if this file was selected
                    selectForPreview(fileObj.id);
                }
            } catch (error) {
                console.error("处理图片出错:", error);
                fileObj.status = 'error';
                fileObj.error = error.message || '处理失败';
                showMessage('error', `${fileObj.file.name}: ${fileObj.error}`);
                renderFileList();
                renderProcessedFileList();
            }
        }

        // 获取文件扩展名的辅助函数
        function getFileExtension(filename) {
            return filename.slice((filename.lastIndexOf('.') - 1 >>> 0) + 2).toLowerCase();
        }
        
        // 获取输出格式的辅助函数
        function getOutputFormat(file, settings) {
            if (settings.outputFormat === 'original') {
                // 检查原始格式是否受支持
                const supportedFormats = ['image/jpeg', 'image/png', 'image/webp'];
                return supportedFormats.includes(file.type) ? file.type : 'image/jpeg';
            }
            return settings.outputFormat;
        }

        // 将上传区域的初始化逻辑封装为函数，以便可以重复调用
        function initializeUploadArea() {
            // 移除可能存在的旧事件监听器
            uploadArea.removeEventListener('click', handleUploadAreaClick);
            uploadArea.removeEventListener('dragover', handleDragOver);
            uploadArea.removeEventListener('dragleave', handleDragLeave);
            uploadArea.removeEventListener('drop', handleDrop);
            fileInput.removeEventListener('change', handleFileInputChange);
            
            // 添加新的事件监听器
            uploadArea.addEventListener('click', handleUploadAreaClick);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            fileInput.addEventListener('change', handleFileInputChange);
        }
        
        // 上传区域点击事件处理函数
        function handleUploadAreaClick() {
            fileInput.click();
        }
        
        // 拖拽相关事件处理函数
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        }
        
        // 文件输入变化事件处理函数
        function handleFileInputChange() {
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
            }
        }
        
        // --- File Upload ---
        // 替换原有的事件绑定代码
        initializeUploadArea();
        
        // --- Initialize ---
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化上传区域
            initializeUploadArea();
            
            // 默认选中自定义压缩并显示对应面板
            document.getElementById('modeCustom').checked = true;
            document.getElementById('customSettingsPanel').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('customSettingsPanel').classList.add('panel-active');
            }, 10);
            
            // 初始化年份
            document.getElementById('currentYear').textContent = new Date().getFullYear();
        });

    </script>
</body>
</html>
